<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Recipe Keeper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #007AFF;
            --secondary-color: #5856D6;
            --success-color: #34C759;
            --danger-color: #FF3B30;
            --warning-color: #FF9500;
            --background: #F2F2F7;
            --card-background: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #6C6C70;
            --border-color: #C6C6C8;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px 16px;
            padding-bottom: 80px;
        }

        .header {
            background: var(--card-background);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .url-input-container {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .url-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .recipe-card {
            background: var(--card-background);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .recipe-header {
            margin-bottom: 20px;
        }

        .recipe-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .recipe-meta {
            display: flex;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            flex-wrap: wrap;
        }

        .recipe-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .recipe-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .serving-adjuster {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--background);
            border-radius: 8px;
            margin: 20px 0;
        }

        .serving-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .serving-count {
            font-size: 18px;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }

        .ingredients-list {
            list-style: none;
            margin: 20px 0;
        }

        .ingredient-item {
            padding: 12px;
            background: var(--background);
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ingredient-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            flex-shrink: 0;
        }

        .ingredient-checkbox.checked {
            background: var(--success-color);
            border-color: var(--success-color);
        }

        .ingredient-checkbox.checked::after {
            content: '‚úì';
            color: white;
            display: block;
            text-align: center;
            line-height: 16px;
        }

        .ingredient-text {
            flex: 1;
        }

        .ingredient-item.checked .ingredient-text {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .steps-list {
            counter-reset: step-counter;
            margin: 20px 0;
        }

        .step-item {
            padding: 15px;
            background: var(--background);
            margin-bottom: 12px;
            border-radius: 8px;
            counter-increment: step-counter;
            position: relative;
            padding-left: 50px;
        }

        .step-item::before {
            content: counter(step-counter);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .step-item.completed {
            opacity: 0.7;
        }

        .step-item.completed::before {
            background: var(--success-color);
            content: '‚úì';
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }

        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
        }

        .recipe-list-item {
            background: var(--card-background);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .recipe-list-item:active {
            transform: scale(0.98);
        }

        .recipe-list-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .recipe-list-meta {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-background);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .error-message {
            background: #FEE;
            color: var(--danger-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        .success-message {
            background: #E8F9E8;
            color: var(--success-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .success-message.active {
            display: block;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background: var(--card-background);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        @media print {
            .bottom-nav,
            .action-buttons,
            .url-input-container,
            .serving-adjuster button,
            .nav-item {
                display: none !important;
            }

            body {
                background: white;
            }

            .container {
                padding-bottom: 20px;
            }

            .recipe-card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        @media (max-width: 375px) {
            .container {
                padding: 15px 12px;
            }

            .recipe-title {
                font-size: 20px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home View -->
        <div id="homeView" class="view-container active">
            <div class="header">
                <h1>üç≥ Recipe Keeper</h1>
                <p style="color: var(--text-secondary);">Save and organize your favorite recipes</p>
                <div class="url-input-container">
                    <input type="url" id="recipeUrl" class="url-input" placeholder="Paste recipe URL here...">
                    <button id="fetchBtn" class="btn btn-primary">Get Recipe</button>
                </div>
            </div>

            <div id="loadingContainer" class="loading">
                <div class="spinner"></div>
                <p>Extracting recipe...</p>
            </div>

            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>

            <div id="recipeContainer"></div>
        </div>

        <!-- My Recipes View -->
        <div id="savedView" class="view-container">
            <div class="header">
                <h1>üìö My Recipes</h1>
                <p style="color: var(--text-secondary);">Your saved recipe collection</p>
            </div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search recipes...">
            </div>

            <div id="savedRecipesContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üìñ</div>
                    <p>No saved recipes yet</p>
                    <p style="font-size: 14px; margin-top: 10px;">Start by adding a recipe URL on the home page</p>
                </div>
            </div>
        </div>

        <!-- Recipe Detail View -->
        <div id="detailView" class="view-container">
            <div id="recipeDetailContainer"></div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" data-view="homeView">
            <div class="nav-icon">üè†</div>
            <div>Home</div>
        </div>
        <div class="nav-item" data-view="savedView">
            <div class="nav-icon">üìö</div>
            <div>My Recipes</div>
        </div>
    </div>

    <script>
        // API Configuration
        const CLAUDE_API_KEY = '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';
        const AIRTABLE_API_KEY = 'patEBCO7niHIayw4Y.738ca84782896cb6beb23875a1017a292718e144f962bde1cbafb21483136120';
        const AIRTABLE_BASE_ID = 'app6wgIiXq8dzEKHq'; // Just the base ID, not the full path
        const AIRTABLE_TABLE_NAME = 'Recipes';

        // App State
        let currentRecipe = null;
        let originalServings = 1;
        let currentServings = 1;
        let savedRecipes = [];

        // View Management
        function showView(viewId) {
            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            const activeNav = document.querySelector(`[data-view="${viewId}"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }

            // Load saved recipes when showing saved view
            if (viewId === 'savedView') {
                loadSavedRecipes();
            }
        }

        // Navigation setup
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.addEventListener('click', () => {
                const viewId = nav.getAttribute('data-view');
                showView(viewId);
            });
        });

        // Fetch recipe from URL
        async function fetchRecipe() {
            const url = document.getElementById('recipeUrl').value.trim();
            if (!url) {
                showError('Please enter a recipe URL');
                return;
            }

            showLoading(true);
            hideMessages();

            try {
                // Fetch webpage content using AllOrigins API
                const allOriginsUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const response = await fetch(allOriginsUrl);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch webpage content');
                }

                const htmlContent = await response.text();

                // Extract recipe using Claude API
                const recipe = await extractRecipeWithClaude(htmlContent, url);
                
                if (recipe) {
                    currentRecipe = recipe;
                    originalServings = recipe.servings || 1;
                    currentServings = originalServings;
                    displayRecipe(recipe);
                    showSuccess('Recipe extracted successfully!');
                }
            } catch (error) {
                console.error('Error fetching recipe:', error);
                showError(`Failed to fetch recipe: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Extract recipe - skip Claude API due to CORS, use enhanced local extraction
        async function extractRecipeWithClaude(htmlContent, sourceUrl) {
            console.log('Extracting recipe from webpage...');
            // Direct to local extraction since Claude API can't be called from browser
            // For production, you'd need a backend server to handle API calls
            return extractRecipeLocally(htmlContent, sourceUrl);
        }

        // Local recipe extraction fallback
        function extractRecipeLocally(htmlContent, sourceUrl) {
            console.log('Using enhanced local extraction...');
            
            const recipe = {
                url: sourceUrl,
                title: 'Recipe from ' + new URL(sourceUrl).hostname,
                ingredients: [],
                servings: 4,
                prepTime: 15,
                cookTime: 30,
                steps: [],
                imageUrl: null
            };

            // First, check for JSON-LD structured data (most recipe sites use this)
            const jsonLdMatches = htmlContent.matchAll(/<script[^>]*type="application\/ld\+json"[^>]*>([\s\S]*?)<\/script>/gi);
            for (const match of jsonLdMatches) {
                try {
                    const jsonData = JSON.parse(match[1]);
                    let recipeData = null;
                    
                    // Handle different JSON-LD structures
                    if (jsonData['@type'] === 'Recipe') {
                        recipeData = jsonData;
                    } else if (Array.isArray(jsonData)) {
                        recipeData = jsonData.find(item => item['@type'] === 'Recipe');
                    } else if (jsonData['@graph']) {
                        recipeData = jsonData['@graph'].find(item => item['@type'] === 'Recipe');
                    }
                    
                    if (recipeData) {
                        recipe.title = recipeData.name || recipe.title;
                        
                        // Handle different image formats
                        if (recipeData.image) {
                            if (typeof recipeData.image === 'string') {
                                recipe.imageUrl = recipeData.image;
                            } else if (recipeData.image.url) {
                                recipe.imageUrl = recipeData.image.url;
                            } else if (Array.isArray(recipeData.image)) {
                                recipe.imageUrl = recipeData.image[0];
                            }
                        }
                        
                        // Extract servings
                        if (recipeData.recipeYield) {
                            const yieldNum = parseInt(recipeData.recipeYield);
                            if (!isNaN(yieldNum)) {
                                recipe.servings = yieldNum;
                            }
                        }
                        
                        // Extract times
                        if (recipeData.prepTime) {
                            const minutes = parseDuration(recipeData.prepTime);
                            if (minutes) recipe.prepTime = minutes;
                        }
                        if (recipeData.cookTime) {
                            const minutes = parseDuration(recipeData.cookTime);
                            if (minutes) recipe.cookTime = minutes;
                        }
                        
                        // Extract ingredients from structured data
                        if (recipeData.recipeIngredient && Array.isArray(recipeData.recipeIngredient)) {
                            recipe.ingredients = recipeData.recipeIngredient.map(ing => {
                                const text = ing.trim();
                                // Improved ingredient parsing
                                const match = text.match(/^([\d\/.¬Ω‚Öì‚Öî¬º¬æ‚Öõ‚Öú‚Öù‚Öû\-\s]+)?\s*(?:\(([\d\/.]+)[^)]*\))?\s*([a-zA-Z]+(?:\s+[a-zA-Z]+)?)\s+(.+)$/);
                                if (match) {
                                    return {
                                        amount: (match[1] || match[2] || '').trim(),
                                        unit: match[3] || '',
                                        item: match[4] || text
                                    };
                                }
                                // Simpler fallback
                                const simplMatch = text.match(/^([\d\/.¬Ω‚Öì‚Öî¬º¬æ‚Öõ‚Öú‚Öù‚Öû\-\s]+)?\s*(.+)$/);
                                if (simplMatch) {
                                    return {
                                        amount: simplMatch[1] || '',
                                        unit: '',
                                        item: simplMatch[2] || text
                                    };
                                }
                                return { amount: '', unit: '', item: text };
                            });
                        }
                        
                        // Extract instructions - handle multiple formats
                        if (recipeData.recipeInstructions) {
                            recipe.steps = recipeData.recipeInstructions
                                .map(inst => {
                                    if (typeof inst === 'string') return inst.trim();
                                    if (inst.text) return inst.text.trim();
                                    if (inst.name) return inst.name.trim();
                                    // Handle AllRecipes format where instructions might be nested
                                    if (inst['@type'] === 'HowToStep' && inst.text) return inst.text.trim();
                                    // Some sites use different property names
                                    if (inst.instruction) return inst.instruction.trim();
                                    if (inst.description) return inst.description.trim();
                                    return '';
                                })
                                .filter(step => step.length > 0);
                        }
                        
                        if (recipe.ingredients.length > 0 || recipe.steps.length > 0) {
                            console.log('Successfully extracted from JSON-LD');
                            return recipe;
                        }
                    }
                } catch (e) {
                    console.error('JSON-LD parsing failed:', e);
                }
            }
            
            // Helper function to parse ISO 8601 duration
            function parseDuration(duration) {
                if (!duration) return null;
                const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
                if (match) {
                    const hours = parseInt(match[1] || 0);
                    const minutes = parseInt(match[2] || 0);
                    return hours * 60 + minutes;
                }
                return null;
            }

            // Try to extract title from various heading tags
            const titlePatterns = [
                /<h1[^>]*class="[^"]*recipe[^"]*"[^>]*>([^<]+)<\/h1>/i,
                /<h1[^>]*>([^<]+)<\/h1>/i,
                /<h2[^>]*class="[^"]*recipe[^"]*"[^>]*>([^<]+)<\/h2>/i,
                /<title>([^<]+)<\/title>/i
            ];
            
            for (const pattern of titlePatterns) {
                const match = htmlContent.match(pattern);
                if (match && match[1].trim()) {
                    recipe.title = match[1].trim().replace(/\s*\|.*$/, '').replace(/Recipe\s*[-‚Äì]\s*/i, '');
                    break;
                }
            }

            // Enhanced ingredient extraction
            const ingredientPatterns = [
                /<li[^>]*class="[^"]*ingredient[^"]*"[^>]*>([\s\S]*?)<\/li>/gi,
                /<li[^>]*itemprop="recipeIngredient"[^>]*>([\s\S]*?)<\/li>/gi,
                /<span[^>]*class="[^"]*ingredient[^"]*"[^>]*>([\s\S]*?)<\/span>/gi,
                /<p[^>]*class="[^"]*ingredient[^"]*"[^>]*>([\s\S]*?)<\/p>/gi
            ];

            for (const pattern of ingredientPatterns) {
                const matches = [...htmlContent.matchAll(pattern)];
                for (const match of matches) {
                    // Remove HTML tags from the matched content
                    const text = match[1].replace(/<[^>]*>/g, '').trim();
                    if (text && text.length > 2) {
                        // Better ingredient parsing
                        const parts = text.match(/^([\d\/.¬Ω‚Öì‚Öî¬º¬æ‚Öõ‚Öú‚Öù‚Öû]+)?\s*([a-zA-Z]+)?\s*(.+)$/);
                        if (parts) {
                            recipe.ingredients.push({
                                amount: parts[1] || '',
                                unit: parts[2] || '',
                                item: parts[3] || text
                            });
                        } else {
                            recipe.ingredients.push({
                                amount: '',
                                unit: '',
                                item: text
                            });
                        }
                    }
                }
                if (recipe.ingredients.length > 0) break;
            }

            // Enhanced steps extraction with AllRecipes-specific patterns
            const stepPatterns = [
                // AllRecipes specific patterns
                /<li[^>]*data-testid="instruction-text"[^>]*>([\s\S]*?)<\/li>/gi,
                /<p[^>]*class="[^"]*recipe-summary__item[^"]*"[^>]*>([\s\S]*?)<\/p>/gi,
                /<div[^>]*class="[^"]*recipe-instruction[^"]*"[^>]*>([\s\S]*?)<\/div>/gi,
                // Generic patterns
                /<li[^>]*class="[^"]*instruction[^"]*"[^>]*>([\s\S]*?)<\/li>/gi,
                /<li[^>]*itemprop="recipeInstructions"[^>]*>([\s\S]*?)<\/li>/gi,
                /<div[^>]*class="[^"]*direction[^"]*"[^>]*>([\s\S]*?)<\/div>/gi,
                /<div[^>]*class="[^"]*step[^"]*"[^>]*>([\s\S]*?)<\/div>/gi,
                /<p[^>]*class="[^"]*instruction[^"]*"[^>]*>([\s\S]*?)<\/p>/gi,
                // Numbered instruction patterns
                /<ol[^>]*class="[^"]*instructions[^"]*"[^>]*>[\s\S]*?<\/ol>/gi
            ];

            for (const pattern of stepPatterns) {
                if (pattern.source.includes('<ol')) {
                    // Handle ordered list extraction
                    const olMatch = htmlContent.match(pattern);
                    if (olMatch) {
                        const liMatches = [...olMatch[0].matchAll(/<li[^>]*>([\s\S]*?)<\/li>/gi)];
                        for (const liMatch of liMatches) {
                            const text = liMatch[1].replace(/<[^>]*>/g, '').trim();
                            if (text && text.length > 10) {
                                recipe.steps.push(text);
                            }
                        }
                    }
                } else {
                    const matches = [...htmlContent.matchAll(pattern)];
                    for (const match of matches) {
                        // Remove HTML tags and clean up
                        const text = match[1].replace(/<[^>]*>/g, '').trim();
                        if (text && text.length > 10) {
                            recipe.steps.push(text);
                        }
                    }
                }
                if (recipe.steps.length > 0) break;
            }

            // Try to find an image
            const imgPatterns = [
                /<img[^>]*class="[^"]*recipe[^"]*"[^>]*src="([^"]+)"/i,
                /<img[^>]*itemprop="image"[^>]*src="([^"]+)"/i,
                /<meta[^>]*property="og:image"[^>]*content="([^"]+)"/i
            ];
            
            for (const pattern of imgPatterns) {
                const match = htmlContent.match(pattern);
                if (match && match[1]) {
                    recipe.imageUrl = match[1];
                    break;
                }
            }

            // Provide helpful message if extraction failed
            if (recipe.ingredients.length === 0) {
                recipe.ingredients = [
                    { amount: '', unit: '', item: 'Could not extract ingredients - please check the original recipe' }
                ];
            }

            if (recipe.steps.length === 0) {
                recipe.steps = ['Could not extract instructions - please check the original recipe'];
            }

            console.log('Local extraction completed:', recipe.title);
            return recipe;
        }

        // Display recipe
        function displayRecipe(recipe) {
            const container = document.getElementById('recipeContainer');
            
            // Ensure imageUrl is a string
            let imageHtml = '';
            if (recipe.imageUrl) {
                const imgUrl = typeof recipe.imageUrl === 'string' 
                    ? recipe.imageUrl 
                    : (recipe.imageUrl.url || '');
                if (imgUrl) {
                    imageHtml = `<img src="${imgUrl}" alt="${recipe.title}" class="recipe-image" onerror="this.style.display='none'">`;
                }
            }
            
            container.innerHTML = `
                <div class="recipe-card">
                    ${imageHtml}
                    <div class="recipe-header">
                        <h2 class="recipe-title">${recipe.title}</h2>
                        <div class="recipe-meta">
                            <div class="recipe-meta-item">‚è±Ô∏è Prep: ${recipe.prepTime || 0} min</div>
                            <div class="recipe-meta-item">üî• Cook: ${recipe.cookTime || 0} min</div>
                            <div class="recipe-meta-item">üçΩÔ∏è Servings: ${recipe.servings || 1}</div>
                        </div>
                    </div>

                    <div class="serving-adjuster">
                        <button class="serving-btn" onclick="adjustServing(-1)">‚àí</button>
                        <div class="serving-count">${currentServings} servings</div>
                        <button class="serving-btn" onclick="adjustServing(1)">+</button>
                    </div>

                    <h3 style="margin: 20px 0 10px;">Ingredients</h3>
                    <ul class="ingredients-list" id="ingredientsList">
                        ${recipe.ingredients.map((ing, idx) => `
                            <li class="ingredient-item" data-index="${idx}">
                                <div class="ingredient-checkbox" onclick="toggleIngredient(${idx})"></div>
                                <div class="ingredient-text">
                                    <span class="ingredient-amount">${formatIngredientAmount(ing.amount, currentServings, originalServings)}</span>
                                    ${ing.unit} ${ing.item}
                                </div>
                            </li>
                        `).join('')}
                    </ul>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showDetailedView()">View Instructions</button>
                        <button class="btn btn-success" onclick="saveRecipe()">Save Recipe</button>
                        <button class="btn btn-outline" onclick="shareRecipe()">Share</button>
                        <button class="btn btn-outline" onclick="printRecipe()">Print</button>
                    </div>
                </div>
            `;
        }

        // Adjust serving size
        function adjustServing(change) {
            const newServings = currentServings + change;
            if (newServings < 1) return;
            
            currentServings = newServings;
            updateServingDisplay();
        }

        // Update serving display
        function updateServingDisplay() {
            // Update serving count
            document.querySelector('.serving-count').textContent = `${currentServings} servings`;
            
            // Update ingredient amounts
            const ingredientItems = document.querySelectorAll('.ingredient-item');
            ingredientItems.forEach((item, idx) => {
                if (currentRecipe && currentRecipe.ingredients[idx]) {
                    const ing = currentRecipe.ingredients[idx];
                    const amountSpan = item.querySelector('.ingredient-amount');
                    if (amountSpan) {
                        amountSpan.textContent = formatIngredientAmount(ing.amount, currentServings, originalServings);
                    }
                }
            });
        }

        // Format ingredient amount
        function formatIngredientAmount(amount, currentServ, originalServ) {
            if (!amount || amount === '') return '';
            
            // Parse fractions and numbers
            const ratio = currentServ / originalServ;
            
            // Handle fractions
            if (amount.includes('/')) {
                const parts = amount.split('/');
                if (parts.length === 2) {
                    const numerator = parseFloat(parts[0]) * ratio;
                    const denominator = parseFloat(parts[1]);
                    
                    // Convert back to fraction or decimal
                    if (numerator % 1 === 0 && denominator % 1 === 0) {
                        return `${numerator}/${denominator}`;
                    } else {
                        return (numerator / denominator).toFixed(2).replace(/\.?0+$/, '');
                    }
                }
            }
            
            // Handle regular numbers
            const num = parseFloat(amount);
            if (!isNaN(num)) {
                const adjusted = num * ratio;
                return adjusted % 1 === 0 ? adjusted.toString() : adjusted.toFixed(2).replace(/\.?0+$/, '');
            }
            
            return amount;
        }

        // Toggle ingredient checkbox
        function toggleIngredient(index) {
            const item = document.querySelector(`.ingredient-item[data-index="${index}"]`);
            const checkbox = item.querySelector('.ingredient-checkbox');
            
            item.classList.toggle('checked');
            checkbox.classList.toggle('checked');
        }

        // Show detailed view with steps
        function showDetailedView() {
            if (!currentRecipe) return;
            
            const container = document.getElementById('recipeDetailContainer');
            container.innerHTML = `
                <div class="recipe-card">
                    <button class="btn btn-outline" onclick="showView('homeView')" style="margin-bottom: 20px;">‚Üê Back</button>
                    
                    <h2 class="recipe-title">${currentRecipe.title}</h2>
                    
                    <div class="recipe-meta">
                        <div class="recipe-meta-item">‚è±Ô∏è Total: ${(currentRecipe.prepTime || 0) + (currentRecipe.cookTime || 0)} min</div>
                        <div class="recipe-meta-item">üçΩÔ∏è ${currentServings} servings</div>
                    </div>

                    <h3 style="margin: 30px 0 15px;">Cooking Instructions</h3>
                    <ol class="steps-list">
                        ${currentRecipe.steps.map((step, idx) => `
                            <li class="step-item" data-step="${idx}" onclick="toggleStep(${idx})">
                                ${step}
                            </li>
                        `).join('')}
                    </ol>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showView('homeView')">Back to Recipe</button>
                        <button class="btn btn-outline" onclick="printRecipe()">Print</button>
                    </div>
                </div>
            `;
            
            showView('detailView');
        }

        // Toggle step completion
        function toggleStep(index) {
            const step = document.querySelector(`.step-item[data-step="${index}"]`);
            step.classList.toggle('completed');
        }

        // Save recipe to Airtable
        async function saveRecipe() {
            if (!currentRecipe) return;
            
            // First try Airtable
            try {
                // Ensure imageUrl is a string or empty
                let thumbnailUrl = '';
                if (currentRecipe.imageUrl) {
                    if (typeof currentRecipe.imageUrl === 'string') {
                        thumbnailUrl = currentRecipe.imageUrl;
                    } else if (currentRecipe.imageUrl.url) {
                        thumbnailUrl = currentRecipe.imageUrl.url;
                    }
                }
                
                const record = {
                    fields: {
                        'URL': currentRecipe.url || '',
                        'Title': currentRecipe.title || 'Untitled Recipe',
                        'Ingredients': JSON.stringify(currentRecipe.ingredients || []),
                        'Servings': parseInt(currentRecipe.servings) || 1,
                        'Preparation Time (min)': parseInt(currentRecipe.prepTime) || 0,
                        'Cooking Time (min)': parseInt(currentRecipe.cookTime) || 0,
                        'Steps': JSON.stringify(currentRecipe.steps || []),
                        'Date Added': new Date().toISOString().split('T')[0],
                        'Thumbnail Image': thumbnailUrl || ''
                    }
                };

                console.log('Saving to Airtable:', record);
                
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(record)
                });

                if (response.ok) {
                    showSuccess('Recipe saved to your collection!');
                    saveToLocalStorage(currentRecipe);
                    // Scroll to top to see success message
                    window.scrollTo(0, 0);
                    return;
                } else {
                    const errorData = await response.json();
                    console.error('Airtable error:', errorData);
                    throw new Error(errorData.error?.message || 'Failed to save to Airtable');
                }
            } catch (error) {
                console.error('Airtable save failed:', error);
                // Fallback to local storage
                saveToLocalStorage(currentRecipe);
                showSuccess('Recipe saved locally!');
                window.scrollTo(0, 0);
            }
        }

        // Save to local storage
        function saveToLocalStorage(recipe) {
            let localRecipes = JSON.parse(localStorage.getItem('savedRecipes') || '[]');
            
            // Clean up the recipe object before saving
            const cleanRecipe = {
                ...recipe,
                imageUrl: typeof recipe.imageUrl === 'string' 
                    ? recipe.imageUrl 
                    : (recipe.imageUrl?.url || null)
            };
            
            // Check if recipe already exists
            const existingIndex = localRecipes.findIndex(r => r.url === cleanRecipe.url);
            if (existingIndex > -1) {
                localRecipes[existingIndex] = cleanRecipe;
            } else {
                localRecipes.unshift(cleanRecipe);
            }
            
            localStorage.setItem('savedRecipes', JSON.stringify(localRecipes));
        }

        // Load saved recipes
        async function loadSavedRecipes() {
            const container = document.getElementById('savedRecipesContainer');
            container.innerHTML = '<div class="loading active"><div class="spinner"></div><p>Loading recipes...</p></div>';

            try {
                // Try to load from Airtable
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?sort[0][field]=Date%20Added&sort[0][direction]=desc`, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    savedRecipes = data.records.map(record => ({
                        id: record.id,
                        url: record.fields['URL'],
                        title: record.fields['Title'],
                        ingredients: JSON.parse(record.fields['Ingredients'] || '[]'),
                        servings: record.fields['Servings'],
                        prepTime: record.fields['Preparation Time (min)'],
                        cookTime: record.fields['Cooking Time (min)'],
                        steps: JSON.parse(record.fields['Steps'] || '[]'),
                        imageUrl: record.fields['Thumbnail Image'] || null
                    }));
                }
            } catch (error) {
                console.error('Failed to load from Airtable:', error);
            }

            // Merge with local storage
            const localRecipes = JSON.parse(localStorage.getItem('savedRecipes') || '[]');
            localRecipes.forEach(localRecipe => {
                if (!savedRecipes.find(r => r.url === localRecipe.url)) {
                    savedRecipes.push(localRecipe);
                }
            });

            displaySavedRecipes();
        }

        // Display saved recipes
        function displaySavedRecipes() {
            const container = document.getElementById('savedRecipesContainer');
            
            if (savedRecipes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìñ</div>
                        <p>No saved recipes yet</p>
                        <p style="font-size: 14px; margin-top: 10px;">Start by adding a recipe URL on the home page</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = savedRecipes.map(recipe => `
                <div class="recipe-list-item" onclick="loadRecipeFromSaved('${recipe.url}')">
                    <div class="recipe-list-title">${recipe.title}</div>
                    <div class="recipe-list-meta">
                        ${recipe.servings} servings ‚Ä¢ ${(recipe.prepTime || 0) + (recipe.cookTime || 0)} min total
                    </div>
                </div>
            `).join('');
        }

        // Load recipe from saved
        function loadRecipeFromSaved(url) {
            const recipe = savedRecipes.find(r => r.url === url);
            if (recipe) {
                currentRecipe = recipe;
                originalServings = recipe.servings || 1;
                currentServings = originalServings;
                displayRecipe(recipe);
                showView('homeView');
            }
        }

        // Search recipes
        document.getElementById('searchInput')?.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if (!query) {
                // Reset if empty
                loadSavedRecipes();
                return;
            }
            
            const filtered = savedRecipes.filter(recipe => {
                // Check title
                if (recipe.title && recipe.title.toLowerCase().includes(query)) {
                    return true;
                }
                
                // Check ingredients
                if (recipe.ingredients && Array.isArray(recipe.ingredients)) {
                    return recipe.ingredients.some(ing => {
                        if (ing && ing.item) {
                            return ing.item.toLowerCase().includes(query);
                        }
                        return false;
                    });
                }
                
                return false;
            });
            
            // Display filtered results without modifying savedRecipes
            const container = document.getElementById('savedRecipesContainer');
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>No recipes found matching "${query}"</p>
                    </div>
                `;
            } else {
                container.innerHTML = filtered.map(recipe => `
                    <div class="recipe-list-item" onclick="loadRecipeFromSaved('${recipe.url}')">
                        <div class="recipe-list-title">${recipe.title}</div>
                        <div class="recipe-list-meta">
                            ${recipe.servings || 0} servings ‚Ä¢ ${((recipe.prepTime || 0) + (recipe.cookTime || 0))} min total
                        </div>
                    </div>
                `).join('');
            }
        });

        // Share recipe
        function shareRecipe() {
            if (!currentRecipe) return;
            
            if (navigator.share) {
                navigator.share({
                    title: currentRecipe.title,
                    text: `Check out this recipe: ${currentRecipe.title}`,
                    url: currentRecipe.url
                }).catch(err => console.log('Share failed:', err));
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(currentRecipe.url).then(() => {
                    showSuccess('Recipe URL copied to clipboard!');
                });
            }
        }

        // Print recipe
        function printRecipe() {
            window.print();
        }

        // UI Helper functions
        function showLoading(show) {
            document.getElementById('loadingContainer').classList.toggle('active', show);
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
            setTimeout(() => errorEl.classList.remove('active'), 5000);
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.classList.add('active');
            setTimeout(() => successEl.classList.remove('active'), 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.remove('active');
            document.getElementById('successMessage').classList.remove('active');
        }

        // Event listeners
        document.getElementById('fetchBtn').addEventListener('click', fetchRecipe);
        document.getElementById('recipeUrl').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                fetchRecipe();
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            // Check for API keys
            if (CLAUDE_API_KEY === 'YOUR_CLAUDE_API_KEY') {
                console.warn('Please add your Claude API key');
            }
            if (AIRTABLE_API_KEY === 'YOUR_AIRTABLE_API_KEY') {
                console.warn('Please add your Airtable API key');
            }
        });
    </script>
</body>
</html>